#!/bin/bash
set -eo pipefail
IFS=$'\n\t'

help() {
    cat <<-EOF
Usage: gh download <repo> <folders | files>

> Download folders or files from GitHub repo with default branch

Arguments:
    <repo>               like: \`username/repo\`, if username is missing, it will use the gh's username
    <folders | files>    folders must end with \`/\`, otherwise they are file

Examples:
    gh download yuler/gh-download README.md gh-download
    gh download cli/cli .github/
EOF
}

download_file() {
    echo "file $1 downloading..."
    curl --location --create-dirs --oauth2-bearer $token https://raw.githubusercontent.com/$repo/$default_branch/$1 -o $1
}

download() {
    if [[ $1 =~ */ ]]; then
        files=$(gh api repos/$repo/git/trees/$default_branch?recursive=1 --jq ".tree[] | select(.type == \"blob\") | .path | select(startswith(\"$1\"))")
        echo "folder $1 downloading..."
        for file in $files; do
            download_file $file
        done
    else
        download_file $1
    fi
}

# main
if [[ -z $1 || $1 == '-h' || $1 == '--help' ]]; then
    help
    exit 0
fi

token=$(gh config get -h github.com oauth_token)

repo=$1
if [[ ! $repo =~ .*/.* ]]; then
    username=$(gh config get -h github.com user)
    repo=$username/$repo
    echo "GitHub repo: $repo"
fi

targets=$@
shift 1

default_branch=$(gh api repos/${repo} --jq ".default_branch")

while (("$#")); do
    download $1
    shift
done
